{"version":3,"sources":["../../../app/controller/session.js"],"names":["underscore","require","module","exports","SessionController","ctx","username","request","body","password","error","indexOf","split","curl","method","dataType","data","login","result","field","config","status","reData","userid","id","app","knex","where","userResult","map","key","Date","length","obj","created_at","update_at","insert","Object","assign","success","Controller"],"mappings":"AAAA;;;;;;;;;;AACA,IAAIA,aAAaC,QAAQ,YAAR,CAAjB;AACAC,OAAOC,OAAP,GAAiB,eAAO;AAAA,QACdC,iBADc;AAAA;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA,uEAERC,GAFQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAGRC,wCAHQ,GAGGD,IAAIE,OAAJ,CAAYC,IAAZ,CAAiBF,QAHpB;AAING,wCAJM,GAIKJ,IAAIE,OAAJ,CAAYC,IAAZ,CAAiBC,QAJtB;;AAAA,sCAKR,CAACH,QAAD,IAAa,CAACG,QALN;AAAA;AAAA;AAAA;;AAMT,qCAAKC,KAAL,CAAW,MAAX;AANS;;AAAA;AASZ;AACA,oCAAIJ,SAASK,OAAT,CAAiB,GAAjB,MAA0B,CAAC,CAA/B,EAAkC;AAC9BL,+CAAWA,SAASM,KAAT,CAAe,GAAf,EAAoB,CAApB,CAAX;AACH;;AAZW;AAAA,uCAcSP,IAAIQ,IAAJ,CAAS,kCAAT,EAA6C;AAC9DC,4CAAQ,MADsD;AAE9DC,8CAAU,MAFoD;AAG9DC,0CAAM;AACFC,+CAAOX,QADL;AAEFG,kDAAUA;AAFR;AAHwD,iCAA7C,CAdT;;AAAA;AAcNS,sCAdM;AAsBNC,qCAtBM,GAsBE,CAAC,IAAD,EAAM,UAAN,EAAiB,OAAjB,EAAyB,MAAzB,EAAiC,YAAjC,CAtBF;AAuBRC,sCAvBQ,GAuBC,EAvBD;;AAAA,sCAyBRF,OAAOG,MAAP,GAAgB,GAzBR;AAAA;AAAA;AAAA;;AA0BFC,sCA1BE,GA0BOJ,OAAOF,IA1Bd;AA2BFO,sCA3BE,GA2BOD,OAAOE,EA3Bd;AAAA;AAAA,uCA4BiB,KAAKC,GAAL,CAASC,IAAT,CAAc,MAAd,EAAsBC,KAAtB,CAA4B,EAACH,IAAID,MAAL,EAA5B,CA5BjB;;AAAA;AA4BFK,0CA5BE;;AA6BRT,sCAAMU,GAAN,CAAU,UAACC,GAAD,EAAS;AACfV,2CAAOU,GAAP,IAAcR,OAAOQ,GAAP,CAAd;AACH,iCAFD;AAGAV,uCAAO,OAAP,IAAkBE,OAAO,eAAP,CAAlB;AACAF,uCAAO,WAAP,IAAqB,IAAIW,IAAJ,EAArB;;AAjCQ,oCAkCHH,WAAWI,MAlCR;AAAA;AAAA;AAAA;;AAmCAC,mCAnCA,GAmCM;AACNC,gDAAY,IAAIH,IAAJ,EADN;AAENV,4CAAQ,CAFF;AAGNc,+CAAW,IAAIJ,IAAJ,EAHL;AAINtB,8CAAUA;AAJJ,iCAnCN;AAyCJ;;AAzCI;AAAA,uCA0CE,KAAKgB,GAAL,CAASC,IAAT,CAAc,MAAd,EAAsBU,MAAtB,CAA6BC,OAAOC,MAAP,CAAc,EAAd,EAAiBlB,MAAjB,EAAyBa,GAAzB,CAA7B,CA1CF;;AAAA;;AA6CR,qCAAKM,OAAL,CAAanB,MAAb;AA7CQ;AAAA;;AAAA;AA+CR,qCAAKV,KAAL,CAAW,kBAAX,EAA+BQ,OAAOG,MAAtC;;AA/CQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA,MACYI,IAAIe,UADhB;;AAmDpB,WAAOpC,iBAAP;AACH,CApDD","file":"session.js","sourcesContent":["'use strict';\nvar underscore = require('underscore');\nmodule.exports = app => {\n    class SessionController extends app.Controller {\n        * login(ctx) {\n            var username = ctx.request.body.username;\n            const password = ctx.request.body.password;\n            if (!username || !password) {\n               this.error('参数有误');\n                return;\n            }\n            // 切割邮箱\n            if (username.indexOf('@') !== -1) {\n                username = username.split('@')[0];\n            }\n\n            const result = yield ctx.curl('http://git.gag.cn/api/v3/session', {\n                method: 'POST',\n                dataType: 'json',\n                data: {\n                    login: username,\n                    password: password\n                }\n            });\n            const field = ['id','username','email','name', 'avatar_url'];\n            let config = {};\n\n            if (result.status < 300) {\n                const reData = result.data;\n                const userid = reData.id;\n                const userResult = yield this.app.knex('user').where({id: userid});\n                field.map((key) => {\n                    config[key] = reData[key]\n                });\n                config['token'] = reData['private_token'];\n                config['update_at'] =new Date();\n                if (!userResult.length ){\n                    let obj = {\n                        created_at: new Date(),\n                        status: 1,\n                        update_at: new Date(),\n                        password: password\n                    };\n                    // 插入新的数据\n                    yield this.app.knex('user').insert(Object.assign({},config, obj))\n                }\n\n                this.success(config);\n            } else {\n                this.error('401 Unauthorized', result.status);\n            }\n        }\n    }\n    return SessionController;\n};\n"]}