{"version":3,"sources":["../../../app/controller/user.js"],"names":["underscore","require","module","exports","UserController","ctx","id","query","userId","undefined","private_token","request","header","token","app","curl","baseUrl","dataType","result","status","success","data","error","field","output","knex","where","user_info","length","map","key","Controller"],"mappings":"AAAA;;;;;;;;;;AACA,IAAMA,aAAaC,QAAQ,YAAR,CAAnB;AACAC,OAAOC,OAAP,GAAiB,eAAO;AAAA,QACdC,cADc;AAAA;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;;;AAGhB;AAHgB,0EAILC,GAJK;AAAA;AAAA;AAAA;AAAA;AAAA;AAKNC,kCALM,GAKDD,IAAIE,KAAJ,CAAUD,EALT;AAMRE,sCANQ,GAMC,EAND;;AAOZ,oCAAIF,MAAMG,SAAV,EAAqB;AACjBD,6CAAS,MAAIF,EAAb;AACH;AACKI,6CAVM,GAUUL,IAAIM,OAAJ,CAAYC,MAAZ,CAAmBC,KAV7B;AAAA;AAAA,uCAWSR,IAAIS,GAAJ,CAAQC,IAAR,CAAgB,KAAKD,GAAL,CAASE,OAAzB,cAAyCR,MAAzC,uBAAiEE,aAAjE,EAAkF;AACnGO,8CAAU;AADyF,iCAAlF,CAXT;;AAAA;AAWNC,sCAXM;;;AAeZ,oCAAIA,OAAOC,MAAP,GAAgB,GAApB,EAAyB;AACrB,yCAAKC,OAAL,CAAaF,OAAOG,IAApB;AACH,iCAFD,MAEO;AACH,yCAAKC,KAAL,CAAWJ,OAAOG,IAAlB,EAAwBH,OAAOC,MAA/B;AACH;;AAnBW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAqBhB;;AArBgB;AAAA;AAAA,kFAsBGd,GAtBH;AAAA;AAAA;AAAA;AAAA;AAAA;AAuBNK,6CAvBM,GAuBUL,IAAIE,KAAJ,CAAUM,KAvBpB;;AAAA,sCAwBR,CAACH,aAAD,IAAkBA,iBAAiBD,SAxB3B;AAAA;AAAA;AAAA;;AAyBR,qCAAKa,KAAL,2CAA0BZ,aAA1B;AAzBQ;;AAAA;AA4BNa,qCA5BM,GA4BE,CAAC,IAAD,EAAM,UAAN,EAAiB,OAAjB,EAAyB,MAAzB,EAAiC,YAAjC,EAA8C,OAA9C,EAAsD,QAAtD,EAA+D,WAA/D,CA5BF;AA6BRC,sCA7BQ,GA6BC,EA7BD;AAAA;AAAA,uCA8BYnB,IAAIS,GAAJ,CAAQW,IAAR,CAAa,MAAb,EACnBC,KADmB,CACb,EAACb,OAAOH,aAAR,EADa,CA9BZ;;AAAA;AA8BNiB,yCA9BM;;AAAA,oCAiCPA,UAAUC,MAjCH;AAAA;AAAA;AAAA;;AAkCR,qCAAKN,KAAL,CAAW,MAAX;AAlCQ;;AAAA;AAAA;AAAA,uCAqCSjB,IAAIS,GAAJ,CAAQC,IAAR,CAAgB,KAAKD,GAAL,CAASE,OAAzB,6BAAwDN,aAAxD,CArCT;;AAAA;AAqCNQ,sCArCM;;;AAuCZ,oCAAIS,UAAUC,MAAV,IAAoBV,OAAOC,MAAP,GAAgB,GAAxC,EAA6C;AACzCI,0CAAMM,GAAN,CAAU,UAACC,GAAD,EAAS;AACfN,+CAAOM,GAAP,IAAcH,UAAU,CAAV,EAAaG,GAAb,CAAd;AACH,qCAFD;AAGA,yCAAKV,OAAL,CAAaI,MAAb;AACH,iCALD,MAKO;AACH,yCAAKF,KAAL,CAAW,MAAX,EAAmB,GAAnB;AACH;;AA9CW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA,MACSR,IAAIiB,UADb;;AAiDpB,WAAO3B,cAAP;AACH,CAlDD","file":"user.js","sourcesContent":["'use strict';\nconst underscore = require('underscore');\nmodule.exports = app => {\n    class UserController extends app.Controller {\n\n        // 获取用户\n        * get_user(ctx) {\n            const id = ctx.query.id;\n            var userId = '';\n            if (id != undefined) {\n                userId = '/'+id;\n            }\n            const private_token = ctx.request.header.token;\n            const result = yield ctx.app.curl(`${this.app.baseUrl}/users${userId}?private_token=${private_token}`, {\n                dataType: 'json'\n            });\n\n            if (result.status < 300) {\n                this.success(result.data);\n            } else {\n                this.error(result.data, result.status);\n            }\n        }\n        // 检查用户token 是否可用\n        * check_user_token(ctx) {\n            const private_token = ctx.query.token;\n            if (!private_token || private_token == undefined) {\n                this.error(`参数有误: token为${private_token}`);\n                return;\n            }\n            const field = ['id','username','email','name', 'avatar_url','token','remark','update_at'];\n            let output = {};\n            const user_info = yield ctx.app.knex('user')\n                .where({token: private_token});\n\n            if (!user_info.length) {\n                this.error('授权失败');\n                return\n            }\n            const result = yield ctx.app.curl(`${this.app.baseUrl}/users?private_token=${private_token}`);\n\n            if (user_info.length && result.status < 300) {\n                field.map((key) => {\n                    output[key] = user_info[0][key]\n                });\n                this.success(output);\n            } else {\n                this.error('授权失败', 401);\n            }\n        }\n    }\n    return UserController;\n};\n"]}